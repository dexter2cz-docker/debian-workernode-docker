#!/bin/bash

cd /tmp

CANNOT_INSTALL=(openafs-modules-dkms apt-show-versions memtest86)
export DEBIAN_FRONTEND=noninteractive

apt update -qqq
apt install ca-certificates apt-listchanges -yqqq

cp -r apt /etc

apt update

#E: Unable to locate package libpbspro
#E: Package 'libssl1.0.0' has no installation candidate

CANNOT_INSTALL=(${CANNOT_INSTALL[*]} $(apt install -s `cat packages_file` 2>&1 | grep -Po "(E: Unable to locate package |E: Package ')\K[^&']+"))

for i in ${CANNOT_INSTALL[*]}; do sed -i "s/^$i$//" packages_file; done

apt install -y `cat packages_file` ./openafs-modules-*

cp krb5.conf /etc
cp -r auto.master.d /etc
cp auto.meta-nfs /etc
cp -r storage /
cp -r openafs /etc

rm -r /var/lib/apt/lists/*
rm /etc/ssh/ssh_host_*

apt-get clean

mkdir -p /afs /packages /auto /scratch /scratch.ssd /cvmfs

ln -sf /afs/ics.muni.cz/software /software
